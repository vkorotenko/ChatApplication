
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Bare - Start Bootstrap Template</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <!-- development version, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- production version, optimized for size and speed -->
    <!--<script src="https://cdn.jsdelivr.net/npm/vue"></script>-->
    <link rel="stylesheet" href="css/chat.css" />
    <!-- styles from template -->
    <!--Определяем базовый адрес для загрузки картинок -->

    <link rel="stylesheet" href="/template/styles/css/main-old.css">
    <link rel="stylesheet" href="/template/styles/css/style.css">
    <link rel="stylesheet" href="/template/styles/css/responsive.css">
    <!-- end styles from template -->
</head>

<body>

    <header class="header">
        <div class="panel">
            <div class="case">
                <div class="panel__wrap row i-mid">
                    <div class="panel__logo"><a href="/"><img src="/images/logo.png" alt=""></a></div>
                    <div class="panel__nav">
                        <ul class="scroll-block" style="vertical-align: bottom">
                            <li><a href="/">Главная</a></li>

                            <li>
                                <a href="chat.html">
                                    Сообщения:                                    
                                    <span class="fas fa-envelope hovered"></span>                                    
                                    <span id="totalUnreadMessages" style="display: none" class="badge badge-notify"></span>
                                </a>                                
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div id="chatApp">
        <!-- Navigation -->


        <main class="main">
            <div class="page page_bg">
                <div class="case">
                    <div class="page__wrap page__wrap_pt-more row row- i-strech">
                        <div class="page__aside col col-lg-3 col-md-12">
                            <div class="apps apps_aside hidden-md hidden-sm hidden-xs">

                            </div>
                        </div>
                        <div class="page__content col col-lg-9 col-md-12">
                            <div class="page__main-title main-title page__main-title main-title_md">Сообщения</div>
                            <div class="messager row i-strech">
                                <div class="messager__nav">
                                    <div class="messager__search-wrap">
                                        <div class="messager__search">
                                            <div class="messager__search-icon"><svg id="SVGDoc" width="18" height="17" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:avocode="https://avocode.com/" viewBox="0 0 23 23"><defs><path d="M171.92848,110.56483c-0.22333,0.21613 -0.51713,0.33486 -0.82715,0.33486c-0.32744,0 -0.633,-0.13077 -0.86011,-0.36812l-5.43489,-5.6864c-1.54332,1.09088 -3.34834,1.66559 -5.24254,1.66559c-5.0453,0 -9.15032,-4.12953 -9.15032,-9.2051c0,-5.07581 4.10502,-9.20534 9.15032,-9.20534c5.04556,0 9.15041,4.12953 9.15041,9.20534c0,2.17235 -0.75986,4.25923 -2.14671,5.91779l5.39394,5.64361c0.45628,0.47743 0.44126,1.2387 -0.03296,1.69778zM152.80051,97.30566c0,3.75164 3.03394,6.80387 6.76329,6.80387c3.72934,0 6.76337,-3.05223 6.76337,-6.80387c0,-3.75187 -3.03403,-6.80411 -6.76337,-6.80411c-3.72934,0 -6.76329,3.05223 -6.76329,6.80411z" id="Path-0"></path></defs><desc>Generated with Avocode.</desc><g transform="matrix(1,0,0,1,-150,-88)"><g><title>Forma 1</title><use xlink:href="#Path-0" fill="#7b7d80" fill-opacity="1"></use></g></g></svg></div>
                                            <input type="text" class="messager__search-input" placeholder="Поиск...">
                                        </div>
                                    </div>
                                    <div class="messager__list">
                                        <a href="#message-1" class="messager__item row i-mid">
                                            <div class="messager__img"><img src="/upload/faceses/round/1.png" alt=""></div>
                                            <div class="messager__persona">
                                                <div class="messager__name">Диана Светлова</div>
                                                <div class="messager__text">Привет, как дела?</div>
                                            </div>
                                        </a>
                                        <a href="#message-2" class="messager__item messager__item_selected row">
                                            <div class="messager__img"><img src="/upload/faceses/round/2.png" alt=""></div>
                                            <div class="messager__persona">
                                                <div class="messager__name">Maксим Петров</div>
                                                <div class="messager__text">Вот так все было. Я отвлекся...</div>
                                            </div>
                                        </a>
                                        <a href="#message-3" class="messager__item row i-mid">
                                            <div class="messager__img"><img src="/upload/faceses/round/3.png" alt=""></div>
                                            <div class="messager__persona">
                                                <div class="messager__name">Андрей Ветров</div>
                                                <div class="messager__text">Да это правда. А Вы...</div>
                                            </div>
                                        </a>
                                        <a href="#message-4" class="messager__item row i-mid">
                                            <div class="messager__img"><img src="/upload/faceses/round/4.png" alt=""></div>
                                            <div class="messager__persona">
                                                <div class="messager__name">Maксим</div>
                                                <div class="messager__text">Вот так все было. Я отвлекся...</div>
                                            </div>
                                        </a>
                                        <a href="#message-5" class="messager__item messager__item_message row">
                                            <div class="messager__img"><img src="/upload/faceses/round/3.png" alt=""></div>
                                            <div class="messager__persona">
                                                <div class="messager__name">Андрей Ветров</div>
                                                <div class="messager__text">Да это правда. А Вы...</div>
                                            </div>
                                            <div class="messager__count">1</div>
                                        </a>
                                        <a href="#message-6" class="messager__item row i-mid">
                                            <div class="messager__img"><img src="/upload/faceses/round/4.png" alt=""></div>
                                            <div class="messager__persona">
                                                <div class="messager__name">Maксим</div>
                                                <div class="messager__text">Вот так все было. Я отвлекся...</div>
                                            </div>
                                        </a>
                                    </div>
                                </div>
                                <div class="messager__area">
                                    <div class="messager__message">
                                        <div class="messager__body">
                                            <div class="message message_to">
                                                <div class="message__img"><img src="/upload/faceses/1.png" alt=""></div>
                                                <div class="message__wrap">Добрый день. Меня зовут Оксана.Представляю компанию «Яблоки солнечного Крыма». </div>
                                                <div class="message__date">18.23</div>
                                            </div>
                                            <div class="message message_from">
                                                <div class="message__img"><img src="/upload/faceses/2.png" alt=""></div>
                                                <div class="message__wrap">Спасибо за предложение, уверен в том, что Ваш продукт качественный, но мы занимаемся нашими российскими яблоками и менять ничего не хотим. К тому же, у меня сейчас нет времени. </div>
                                                <div class="message__date">18:27</div>
                                            </div>
                                            <div class="message message_to">
                                                <div class="message__img"><img src="/upload/faceses/1.png" alt=""></div>
                                                <div class="message__wrap">Я понимаю, что у Вас есть российские яблоки, но я Вам предлагаю новый продукт.</div>
                                                <div class="message__date">18.39</div>
                                            </div>
                                            <div class="message message_from">
                                                <div class="message__img"><img src="/upload/faceses/2.png" alt=""></div>
                                                <div class="message__wrap">На данный момент у меня завален склад яблоками, зайдите через две недели…Да это огромный труд, но для нас всегда было важно видеть счастливые лица наших покупателей. К тому же, у меня сейчас нет времени.</div>
                                                <div class="message__date">23:14</div>
                                            </div>
                                            <div class="message message_to">
                                                <div class="message__img"><img src="/upload/faceses/1.png" alt=""></div>
                                                <div class="message__wrap">Нет, ну Вы послушайте. Многие, кто самокритично к себе относится, конечно же, узнали в этом поведении себя...</div>
                                                <div class="message__date">19.43</div>
                                            </div>
                                            <div class="message message_from">
                                                <div class="message__img"><img src="/upload/faceses/2.png" alt=""></div>
                                                <div class="message__wrap">Да это огромный труд, но для нас всегда было важно видеть счастливые лица наших покупателей. К тому же, у меня сейчас нет времени.</div>
                                                <div class="message__date">20:07</div>
                                            </div>
                                            <div class="message message_to">
                                                <div class="message__img"><img src="/upload/faceses/1.png" alt=""></div>
                                                <div class="message__wrap"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24" height="6" viewBox="0 0 24 6"><defs><path id="6o18a" d="M833 945a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm9 0a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm9 0a3 3 0 1 1 0 6 3 3 0 0 1 0-6z"></path></defs><g><g opacity=".6" transform="translate(-830 -945)"><use fill="#828c8f" xlink:href="#6o18a"></use></g></g></svg></div>
                                                <div class="message__date"></div>
                                            </div>
                                        </div>
                                        <div class="messager__foot">
                                            <div class="messager__textarea"><textarea placeholder="Напишите сообщение..."></textarea></div>
                                            <div class="messager__control row">
                                                <div class="messager__file file file_small">
                                                    <label for="file-1"><svg id="clip" width="16" height="14" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:avocode="https://avocode.com/" viewBox="0 0 23 21"><defs><path d="M175.5096,860.07065l-0.10454,-0.10207c-2.30241,-2.21256 -5.99004,-2.1892 -8.26318,0.06829l-10.52525,10.44786c-0.79299,0.78892 -1.64675,2.22011 -1.64675,3.50215c0,1.20297 0.47318,2.33584 1.33132,3.18694c0.85848,0.85218 2.00046,1.32229 3.21548,1.32229h0.00069c1.21493,-0.00144 2.357,-0.47083 3.21479,-1.32373l9.08569,-9.01703c0.62407,-0.61963 0.96602,-1.47792 0.93616,-2.35669c-0.02918,-0.80581 -0.36092,-1.5631 -0.93616,-2.13242c-0.60442,-0.59951 -1.40694,-0.92945 -2.26172,-0.92945c-0.85539,0 -1.65851,0.32958 -2.26164,0.92945l-6.95804,6.90618c-0.17535,0.17216 -0.28487,0.41045 -0.28487,0.67391c0,0.52151 0.42598,0.94598 0.95238,0.94598c0.2629,0 0.50065,-0.10675 0.67266,-0.27783l0.00069,0.00144l6.96507,-6.91373c0.24899,-0.24656 0.59232,-0.36768 0.93478,-0.36193c0.32907,0.00503 0.65472,0.12651 0.89478,0.36409c0.23131,0.22967 0.36572,0.53589 0.37723,0.85972c0.01287,0.36049 -0.12145,0.69978 -0.37851,0.95425l-9.08544,9.01775c-0.49928,0.49492 -1.16241,0.76807 -1.86785,0.76879h-0.00069c-0.70553,0 -1.36934,-0.27387 -1.86862,-0.76879c-0.4979,-0.4942 -0.77299,-1.15121 -0.77299,-1.8492c0,-0.58693 0.49928,-1.57784 1.08945,-2.16512l10.52525,-10.4475c1.54126,-1.53183 4.04451,-1.54261 5.59994,-0.03774l0.10111,0.10064c1.49174,1.548 1.47071,4.01144 -0.0624,5.53429l-8.71164,8.64575c-0.17467,0.17216 -0.28324,0.40937 -0.28324,0.67283c0,0.52151 0.42598,0.9449 0.95281,0.9449c0.26281,0 0.49996,-0.10567 0.67223,-0.27603l0.00069,0.00072l8.71636,-8.65007c2.2861,-2.27079 2.297,-5.95516 0.03399,-8.23889z" id="Path-03333"></path></defs><desc></desc><g transform="matrix(1,0,0,1,-155,-858)"><g><title>Forma 1</title><use xlink:href="#Path-03333" fill="#5d6064" fill-opacity="1"></use></g></g></svg><span>Добавить файл</span></label>
                                                    <input type="file" id="file-1">
                                                </div>
                                                <button class="messager__btn btn btn_bg-yellow"><span>Отправить</span></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <!-- Bootstrap core JavaScript -->
    <script src="https://code.jquery.com/jquery-3.4.0.min.js"
            integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script>
        var tokenKey = "accessToken";
        var sessionToken = sessionStorage.getItem(tokenKey);    

        var app = new Vue({
            el: '#chatApp',
            data: {
                unreadMessage: 6,
                users: []
            }
        });
        GetUserData();
        function GetUserData() {
            var sessionToken = sessionStorage.getItem(tokenKey);    
            var req = $.ajax({
                type: 'GET',
                url: '/api/v1/user',
                beforeSend: function (xhr) {                
                    xhr.setRequestHeader("Authorization", "Bearer " + sessionToken);
                },
                success: function(data) {
                    var countBox = $('#totalUnreadMessages');
                    var count = data.messages;
                    countBox.text(count);
                    if (count > 0)
                        countBox.show();
                    console.log(data);
                }
            });

            req.fail(function(data, status) {                                   
                if (data.status == 401) {
                    var te = data.getResponseHeader('Token-Expired');
                    if (te)
                        RefreshToken(sessionToken);
                }                
                else
                    console.log('err');
            });
        }

        function RefreshToken(token) {
            var bd = {token: token};
            var req = $.ajax({
                type: 'POST',
                url: '/api/v1/account/refresh',
                data: JSON.stringify(bd),
                contentType: "application/json",
                beforeSend: function (xhr) {                
                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                },
                success: function (data) {
                    sessionStorage.setItem(tokenKey, data.access_token);
                    sessionToken = data.access_token;
                    GetUserData();
                }
            });
        }
    </script>

</body>

</html>